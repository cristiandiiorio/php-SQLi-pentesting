<!DOCTYPE html>
<html>
<head>
    <title>PHP SQLi pentesting</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <style>
        body {
            text-align: center;
        }
    </style>
</head>
<body>

<?php
    $host = 'postgres';
    $user = 'user';
    $pass = '.UYr930Qr!3k';
    $db = 'database';

    $conn = new PDO("pgsql:host=$host;dbname=$db", $user, $pass);

    if (!$conn) {
        die("Connection failed");
    }

    // Check if search form is submitted
    if (isset($_GET['search'])) {
        $searchTerm = $_GET['search'];
        $query = "SELECT id,student_name,last_name,sex
                  FROM students_partial
                  WHERE id 
                  LIKE '%$searchTerm%'";
    } else {
        $query = "SELECT * FROM students_partial";
    }

    // Execute
    $result = $conn->query($query);

    // Check if query has yielded no results
    if ($result->rowCount() === 0) {
        echo "No results:  " . $searchTerm;
        echo "<br>";
    }

    // Check
    if ($result) {
        // Fetch 
        $rows = $result->fetchAll(PDO::FETCH_ASSOC);
        echo "<h2 >Student List</h2>";
        echo "<form method='GET'>";
        echo "<input type='text' name='search' class='my-search' placeholder='Search by id'>";
        echo "<input type='submit' value='Search'>";
        echo "</form>";

        echo "<table class='my-table'>";
        echo "<tr><th>ID</th><th>Name</th><th>Last name</th><th>Sex</th></tr>";

        foreach ($rows as $row) {
            echo "<tr>";
            foreach ($row as $field) {
                echo "<td>" . $field . "</td>";
            }
            echo "</tr>";
        }

        echo "</table>";
        
        echo "<br>";

        echo "<h2>Add a new student</h2>";
        echo "<form method='POST'>";
        echo "<input type='radio' name='sex' value='M' checked> M";
        echo "<input type='radio' name='sex' value='F'> F";
        echo "  ";
        echo "<input type='text' name='name' placeholder='name'>";
        echo "<input type='text' name='last_name' placeholder='last_name'>";
        echo "<input type='submit' name='add' value='Add Student'>";
        echo "</form>";

        //var
        $name = $last_name = $sex = $id = "";

        if (isset($_POST['add'])) {
            $id = rand(10000, 99999);
            $sex = $_POST['sex'];
            $name = $_POST['name'];
            $last_name = $_POST['last_name'];
            
            $insertQuery = "INSERT INTO students (id, sex, student_name, last_name) VALUES ('$id','$sex', '$name', '$last_name')";
            $insertResult = $conn->exec($insertQuery);

            if ($insertResult) {
                echo "Student added successfully";
                echo "<br>";
                echo "id:$id,sex: $sex ,name: $name, last_name: $last_name";
            } else {
                echo "Error adding student";
                echo "<br>";
                echo "id:$id,sex: $sex ,name: $name, last_name: $last_name";
            }
        }
        
        
    } else {
        echo "Error executing the query";
    }

?>

    </body>
</html>